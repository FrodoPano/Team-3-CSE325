@page "/account"
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using PasswordAdmin.Models
@inject UserService userService
@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<PageTitle>Account Settings</PageTitle>

<h3>Account Settings</h3>

@if (isLoading)
{
    <p>Loading...</p>
}
else if (user == null)
{
    <div class="alert alert-warning">
        <p>User not found.</p>
    </div>
}
else
{
    <EditForm Model="@user" OnValidSubmit="@SaveSettings">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="form-group mb-3">
            <label>Email</label>
            <InputText @bind-Value="user.Email" class="form-control" disabled />
        </div>

        <div class="form-group mb-3">
            <label>First Name</label>
            <InputText @bind-Value="user.FirstName" class="form-control" />
        </div>

        <div class="form-group mb-3">
            <label>Last Name</label>
            <InputText @bind-Value="user.LastName" class="form-control" />
        </div>

        <div class="form-group mb-3">
            <label>Phone Number</label>
            <InputText @bind-Value="user.PhoneNumber" class="form-control" />
        </div>

        <div class="form-check mb-3">
            <InputCheckbox @bind-Value="user.EmailNotifications" />
            <label>Receive Email Notifications</label>
        </div>

        <div class="form-check mb-3">
            <InputCheckbox @bind-Value="user.TwoFactorEnabled" />
            <label>Enable Two-Factor Auth</label>
        </div>

        <div class="form-group mb-3">
            <label>Theme</label>
            <InputSelect @bind-Value="user.Theme" class="form-control">
                <option value="Light">Light</option>
                <option value="Dark">Dark</option>
                <option value="System">System Default</option>
            </InputSelect>
        </div>

        <div class="form-group mb-3">
            <label>Language</label>
            <InputSelect @bind-Value="user.LanguagePreferance" class="form-control">
                <option value="en">English</option>
                <option value="es">Español</option>
                <option value="fr">Français</option>
            </InputSelect>
        </div>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="alert alert-@messageType">@message</div>
        }

        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary ms-2" @onclick="Cancel">Cancel</button>
        <button type="button" class="btn btn-danger ms-2" @onclick="Logout">Logout</button>
    </EditForm>
}

@code {
    private User? user;
    private User originalUser = new();
    private bool isLoading = true;
    private string message = string.Empty;
    private string messageType = "info";

    protected override async Task OnInitializedAsync()
    {
        await LoadUser();
    }

    private async Task LoadUser()
    {
        isLoading = true;
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var identityUser = await UserManager.GetUserAsync(authState.User);

            if (identityUser != null)
            {
                user = await userService.GetUserByEmail(identityUser.Email ?? "");
                if (user != null)
                    originalUser = user.Clone();
            }
        }
        catch (Exception ex)
        {
            message = $"Error loading user: {ex.Message}";
            messageType = "danger";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SaveSettings()
    {
        if (user == null) return;

        var (ok, msg, updatedUser) = await userService.Update(user);

        if (ok && updatedUser != null)
        {
            message = "Settings saved successfully!";
            messageType = "success";
            user.CopyFrom(updatedUser);
            originalUser.CopyFrom(updatedUser);
        }
        else
        {
            message = $"Error: {msg}";
            messageType = "danger";
        }
    }

    private void Cancel()
    {
        if (user != null)
            user.CopyFrom(originalUser);
        message = string.Empty;
    }

    private async Task Logout()
    {
        await SignInManager.SignOutAsync();
        Navigation.NavigateTo("/");
    }
}
